<div class="purchase-order-container">
  <!-- Header -->
  <div class="page-header">
    <div class="header-content">
      <a routerLink="/purchases/orders" class="btn-back">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <line x1="19" y1="12" x2="5" y2="12"></line>
          <polyline points="12 19 5 12 12 5"></polyline>
        </svg>
        <span>Retour</span>
      </a>
      <h1 class="page-title">
        <svg class="title-icon" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <circle cx="9" cy="21" r="1"></circle>
          <circle cx="20" cy="21" r="1"></circle>
          <path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"></path>
        </svg>
        Nouvelle Commande Fournisseur
      </h1>
    </div>
  </div>

  <!-- Form -->
  <form [formGroup]="orderForm" (ngSubmit)="onSubmit()" class="order-form">
    <div class="form-layout">
      
      <!-- Left Column - Details -->
      <div class="details-column">
        <div class="form-card">
          <div class="card-header">
            <svg class="card-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
              <polyline points="14 2 14 8 20 8"></polyline>
              <line x1="16" y1="13" x2="8" y2="13"></line>
              <line x1="16" y1="17" x2="8" y2="17"></line>
              <polyline points="10 9 9 9 8 9"></polyline>
            </svg>
            <h2>Détails de la commande</h2>
          </div>
          <div class="card-body">
            
            <!-- Supplier -->
            <div class="form-group">
              <label class="form-label">
                Fournisseur
                <span class="required">*</span>
              </label>
              <div class="select-wrapper">
                <svg class="select-icon" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <rect x="1" y="3" width="15" height="13"></rect>
                  <polygon points="16 8 20 8 23 11 23 16 16 16 16 8"></polygon>
                  <circle cx="5.5" cy="18.5" r="2.5"></circle>
                  <circle cx="18.5" cy="18.5" r="2.5"></circle>
                </svg>
                <select 
                  formControlName="fournisseurId" 
                  class="form-select"
                  [class.invalid]="orderForm.get('fournisseurId')?.invalid && orderForm.get('fournisseurId')?.touched"
                >
                  <option [ngValue]="null">Choisir un fournisseur...</option>
                  <option *ngFor="let f of suppliers" [value]="f.id">{{ f.nom }}</option>
                </select>
              </div>
              <span 
                *ngIf="orderForm.get('fournisseurId')?.invalid && orderForm.get('fournisseurId')?.touched"
                class="error-text"
              >
                Veuillez sélectionner un fournisseur
              </span>
            </div>

            <!-- Warehouse -->
            <div class="form-group">
              <label class="form-label">
                Entrepôt de réception
                <span class="required">*</span>
              </label>
              <div class="select-wrapper">
                <svg class="select-icon" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
                  <polyline points="9 22 9 12 15 12 15 22"></polyline>
                </svg>
                <select 
                  formControlName="entrepotId" 
                  class="form-select"
                  [class.invalid]="orderForm.get('entrepotId')?.invalid && orderForm.get('entrepotId')?.touched"
                >
                  <option [ngValue]="null">Choisir un entrepôt...</option>
                  <option *ngFor="let w of warehouses" [value]="w.id">{{ w.nom }}</option>
                </select>
              </div>
              <span 
                *ngIf="orderForm.get('entrepotId')?.invalid && orderForm.get('entrepotId')?.touched"
                class="error-text"
              >
                Veuillez sélectionner un entrepôt
              </span>
            </div>

            <!-- Delivery Date -->
            <div class="form-group">
              <label class="form-label">Date de livraison prévue</label>
              <div class="input-wrapper">
                <svg class="input-icon" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                  <line x1="16" y1="2" x2="16" y2="6"></line>
                  <line x1="8" y1="2" x2="8" y2="6"></line>
                  <line x1="3" y1="10" x2="21" y2="10"></line>
                </svg>
                <input 
                  type="date" 
                  formControlName="dateLivraisonPrevue" 
                  class="form-input"
                >
              </div>
            </div>

            <!-- Total Summary Card -->
            <div class="summary-card">
              <div class="summary-row">
                <span class="summary-label">Total estimé HT</span>
                <span class="summary-value">{{ calculateTotal() | currency:'EUR' }}</span>
              </div>
            </div>

          </div>
        </div>
      </div>

      <!-- Right Column - Products -->
      <div class="products-column">
        <div class="form-card products-card">
          <div class="card-header">
            <div class="header-left">
              <svg class="card-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"></path>
              </svg>
              <h2>Produits à commander</h2>
            </div>
            <button type="button" class="btn-add-line" (click)="addProductLine()">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <line x1="12" y1="5" x2="12" y2="19"></line>
                <line x1="5" y1="12" x2="19" y2="12"></line>
              </svg>
              <span>Ajouter</span>
            </button>
          </div>
          
          <div class="card-body products-body">
            <div class="products-table-wrapper">
              <table class="products-table">
                <thead>
                  <tr>
                    <th class="col-product">Produit</th>
                    <th class="col-quantity">Quantité</th>
                    <th class="col-price">Prix unitaire HT</th>
                    <th class="col-total">Total ligne</th>
                    <th class="col-actions"></th>
                  </tr>
                </thead>
                <tbody formArrayName="lignes">
                  <tr *ngFor="let item of lignes.controls; let i=index" [formGroupName]="i" class="product-line">
                    <td class="col-product">
                      <div class="select-wrapper select-compact">
                        <select formControlName="produitId" class="form-select">
                          <option [ngValue]="null">Sélectionner un produit...</option>
                          <option *ngFor="let p of products" [value]="p.id">{{ p.nom }}</option>
                        </select>
                      </div>
                    </td>
                    <td class="col-quantity">
                      <input 
                        type="number" 
                        formControlName="quantite" 
                        class="form-input form-input-compact"
                        min="1"
                        placeholder="1"
                      >
                    </td>
                    <td class="col-price">
                      <div class="input-wrapper input-wrapper-compact">
                        <span class="currency-symbol">€</span>
                        <input 
                          type="number" 
                          formControlName="prixUnitaire" 
                          class="form-input form-input-compact"
                          step="0.01"
                          placeholder="0.00"
                        >
                      </div>
                    </td>
                    <td class="col-total">
                      <span class="line-total">
                        {{ (item.get('quantite')?.value * item.get('prixUnitaire')?.value) | currency:'EUR' }}
                      </span>
                    </td>
                    <td class="col-actions">
                      <button 
                        type="button" 
                        class="btn-delete-line" 
                        (click)="removeLine(i)"
                        title="Supprimer"
                      >
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                          <polyline points="3 6 5 6 21 6"></polyline>
                          <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                          <line x1="10" y1="11" x2="10" y2="17"></line>
                          <line x1="14" y1="11" x2="14" y2="17"></line>
                        </svg>
                      </button>
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>

            <!-- Empty State -->
            <div *ngIf="lignes.length === 0" class="empty-products">
              <svg class="empty-icon" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                <path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"></path>
              </svg>
              <p>Aucun produit ajouté</p>
              <button type="button" class="btn-add-first" (click)="addProductLine()">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <line x1="12" y1="5" x2="12" y2="19"></line>
                  <line x1="5" y1="12" x2="19" y2="12"></line>
                </svg>
                Ajouter le premier produit
              </button>
            </div>
          </div>
        </div>

        <!-- Form Actions -->
        <div class="form-actions">
          <button type="button" routerLink="/purchases/orders" class="btn-cancel">
            Annuler
          </button>
          <button 
            type="submit" 
            class="btn-submit" 
            [disabled]="orderForm.invalid"
          >
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <polyline points="20 6 9 17 4 12"></polyline>
            </svg>
            <span>Créer le bon de commande</span>
          </button>
        </div>
      </div>

    </div>
  </form>
</div>